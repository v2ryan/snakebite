<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>snakebite — game</title>
  <style>
    :root { color-scheme: dark; }
    body {
      margin: 0;
      min-height: 100vh;
      display: grid;
      place-items: center;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background: radial-gradient(1200px 800px at 50% 40%, #1b263a 0%, #0b1020 55%, #060914 100%);
      color: #e6edf3;
    }
    .wrap {
      width: min(92vw, 720px);
      display: grid;
      gap: 14px;
      padding: 18px;
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 16px;
      background: rgba(0,0,0,0.25);
      box-shadow: 0 10px 30px rgba(0,0,0,0.35);
    }
    header { display: flex; justify-content: space-between; align-items: baseline; gap: 12px; }
    h1 { font-size: 18px; margin: 0; letter-spacing: 0.3px; }
    .meta { display:flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    .pill {
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.10);
      font-size: 12px;
      color: rgba(230,237,243,0.9);
    }
    canvas {
      width: 100%;
      aspect-ratio: 1 / 1;
      border-radius: 12px;
      background:
        linear-gradient(transparent 31px, rgba(255,255,255,0.035) 32px),
        linear-gradient(90deg, transparent 31px, rgba(255,255,255,0.035) 32px),
        linear-gradient(rgba(255,255,255,0.05), rgba(255,255,255,0.02));
      background-size: 32px 32px, 32px 32px, cover;
      border: 1px solid rgba(255,255,255,0.10);
      image-rendering: pixelated;
    }
    .controls {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      align-items: center;
    }
    .help { font-size: 12px; line-height: 1.4; color: rgba(230,237,243,0.75); }
    button {
      appearance: none;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.08);
      color: #e6edf3;
      padding: 10px 12px;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
    }
    button:hover { background: rgba(255,255,255,0.12); }
    button:active { transform: translateY(1px); }

    .dpad {
      display: none;
      gap: 10px;
      justify-items: center;
      padding: 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.04);
    }
    .dpad .row { display: flex; gap: 10px; }
    .dpad .row.small { gap: 10px; }
    .dpad .pad {
      width: 64px;
      height: 52px;
      display: grid;
      place-items: center;
      font-size: 18px;
      padding: 0;
      user-select: none;
      touch-action: manipulation;
    }
    .dpad .row.small .pad { width: 110px; font-size: 14px; }

    @media (max-width: 720px) {
      .dpad { display: grid; }
    }

    .leaderboard{
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.18);
      border-radius: 12px;
      padding: 12px;
      display: grid;
      gap: 8px;
    }
    .lb-title{font-weight:800; font-size:12px; letter-spacing:.2px; color:rgba(230,237,243,.85)}
    .lb-list{margin:0; padding-left: 18px; color:rgba(230,237,243,.9)}
    .lb-list li{margin:4px 0; font-size:12px}
    .lb-muted{color:rgba(230,237,243,.65); font-size:12px}

    .footer {
      display:flex; justify-content: space-between; gap: 12px; flex-wrap: wrap;
      font-size: 12px; color: rgba(230,237,243,0.65);
    }
    a { color: rgba(120,200,255,0.95); text-decoration: none; }
    a:hover { text-decoration: underline; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>snakebite</h1>
      <div class="meta">
        <span class="pill">Score: <span id="score">0</span></span>
        <span class="pill">Best: <span id="best">0</span></span>
        <span class="pill" id="status">Ready</span>
      </div>
    </header>

    <canvas id="c" width="640" height="640" aria-label="Snake game"></canvas>

    <div class="controls">
      <div class="help">
        Controls: <b>Arrow keys</b> or <b>WASD</b> • <b>Space</b> pause • <b>R</b> restart • On mobile: swipe on the board.
      </div>
      <button id="btn">Start</button>


      <div class="dpad" aria-label="On-screen controls">
        <button class="pad" data-dir="up" aria-label="Up">▲</button>
        <div class="row">
          <button class="pad" data-dir="left" aria-label="Left">◀</button>
          <button class="pad" data-dir="down" aria-label="Down">▼</button>
          <button class="pad" data-dir="right" aria-label="Right">▶</button>
        </div>
        <div class="row small">
          <button class="pad" data-action="pause" aria-label="Pause or resume">Pause</button>
          <button class="pad" data-action="restart" aria-label="Restart">Restart</button>
        </div>
      </div>
    </div>

    <div class="leaderboard" id="leaderboard">
      <div class="lb-title">Top 10 排行榜</div>
      <ol class="lb-list" id="lbList"><li class="lb-muted">載入中…</li></ol>
      <div class="lb-muted" id="lbHint">完成一局後會自動提交分數（匿名）</div>
    </div>

    <div class="footer">
      <div><a href="./index.html">Gear</a> • GitHub Pages demo • No dependencies</div>
      <div><a href="https://github.com/v2ryan/snakebite" target="_blank" rel="noreferrer">source</a></div>
    </div>
  </div>

<script>
(() => {
  const canvas = document.getElementById('c');
  const ctx = canvas.getContext('2d');
  const scoreEl = document.getElementById('score');
  const bestEl  = document.getElementById('best');
  const statusEl= document.getElementById('status');
  const btn = document.getElementById('btn');

  const GRID = 20;                 // 20x20 grid
  const CELL = canvas.width / GRID;
  const TICK_MS_START = 140;
  const SPEEDUP_EVERY = 6;         // speed up after every N foods
  const SPEEDUP_FACTOR = 0.92;

  const keyDirs = {
    'ArrowUp': [0,-1], 'KeyW':[0,-1],
    'ArrowDown':[0,1], 'KeyS':[0,1],
    'ArrowLeft':[-1,0], 'KeyA':[-1,0],
    'ArrowRight':[1,0], 'KeyD':[1,0],
  };

  let state;
  let raf = null;
  let last = 0;
  let acc = 0;
  let paused = true;

  function randCell(exceptSet) {
    while (true) {
      const x = Math.floor(Math.random()*GRID);
      const y = Math.floor(Math.random()*GRID);
      const k = x+','+y;
      if (!exceptSet.has(k)) return {x,y};
    }
  }

  function loadBest() {
    const v = Number(localStorage.getItem('snakebite_best')||'0');
    return Number.isFinite(v) ? v : 0;
  }
  function saveBest(v){ localStorage.setItem('snakebite_best', String(v)); }

  function reset() {
    const start = {x: Math.floor(GRID/2), y: Math.floor(GRID/2)};
    state = {
      snake: [start, {x:start.x-1, y:start.y}, {x:start.x-2, y:start.y}],
      dir: [1,0],
      nextDir: [1,0],
      score: 0,
      foods: 0,
      tickMs: TICK_MS_START,
      over: false,
    };
    paused = true;
    scoreEl.textContent = '0';
    bestEl.textContent = String(loadBest());
    statusEl.textContent = 'Ready';
    btn.textContent = 'Start';
    placeFood();
    draw();
  }

  function setStatus(txt){ statusEl.textContent = txt; }

  function setDir(d) {
    // prevent 180-degree turn
    const [dx,dy] = d;
    const [cdx,cdy] = state.dir;
    if (dx === -cdx && dy === -cdy) return;
    state.nextDir = d;
  }

  function start() {
    if (state.over) reset();
    paused = false;
    btn.textContent = 'Pause';
    setStatus('Playing');
    if (!raf) {
      last = performance.now();
      acc = 0;
      raf = requestAnimationFrame(loop);
    }
  }

  function togglePause() {
    if (state.over) return;
    paused = !paused;
    btn.textContent = paused ? 'Resume' : 'Pause';
    setStatus(paused ? 'Paused' : 'Playing');
  }

  function gameOver() {
    state.over = true;
    paused = true;
    btn.textContent = 'Restart';
    setStatus('Game over');
    // submit score to Firestore leaderboard
    try { window.__snakebite_lb?.submitScore?.(state.score); } catch(e) {}
    const best = loadBest();
    if (state.score > best) {
      saveBest(state.score);
      bestEl.textContent = String(state.score);
    }
  }

  function step() {
    if (paused || state.over) return;

    state.dir = state.nextDir;
    const head = state.snake[0];
    const nx = head.x + state.dir[0];
    const ny = head.y + state.dir[1];

    // wall collision
    if (nx < 0 || nx >= GRID || ny < 0 || ny >= GRID) {
      gameOver();
      return;
    }

    const newHead = {x:nx, y:ny};

    // self collision (allow moving into the tail if it will move away)
    const tail = state.snake[state.snake.length-1];
    const willEat = (newHead.x === state.food.x && newHead.y === state.food.y);
    for (let i=0; i<state.snake.length; i++) {
      const p = state.snake[i];
      const isTail = (p.x===tail.x && p.y===tail.y && i===state.snake.length-1);
      if (p.x===newHead.x && p.y===newHead.y && !(isTail && !willEat)) {
        gameOver();
        return;
      }
    }

    state.snake.unshift(newHead);

    if (willEat) {
      state.score += 10;
      state.foods += 1;
      scoreEl.textContent = String(state.score);

      // speed up
      if (state.foods % SPEEDUP_EVERY === 0) {
        state.tickMs = Math.max(60, Math.floor(state.tickMs * SPEEDUP_FACTOR));
      }

      placeFood();
    } else {
      state.snake.pop();
    }
  }

  function placeFood() {
    const set = new Set(state.snake.map(p => p.x+','+p.y));
    state.food = randCell(set);
  }

  function draw() {
    ctx.clearRect(0,0,canvas.width,canvas.height);

    // food
    ctx.fillStyle = '#ff4d6d';
    ctx.beginPath();
    ctx.roundRect(state.food.x*CELL+6, state.food.y*CELL+6, CELL-12, CELL-12, 8);
    ctx.fill();

    // snake
    for (let i=state.snake.length-1; i>=0; i--) {
      const p = state.snake[i];
      const isHead = i===0;
      ctx.fillStyle = isHead ? '#6ee7ff' : '#63ff9b';
      const pad = isHead ? 4 : 6;
      ctx.beginPath();
      ctx.roundRect(p.x*CELL+pad, p.y*CELL+pad, CELL-pad*2, CELL-pad*2, 10);
      ctx.fill();
    }

    // overlay text
    if (paused && !state.over) {
      ctx.fillStyle = 'rgba(0,0,0,0.35)';
      ctx.fillRect(0,0,canvas.width,canvas.height);
      ctx.fillStyle = 'rgba(230,237,243,0.95)';
      ctx.font = '600 28px system-ui, -apple-system, Segoe UI, Roboto';
      ctx.textAlign = 'center';
      ctx.fillText('Press Start', canvas.width/2, canvas.height/2 - 10);
      ctx.font = '14px system-ui, -apple-system, Segoe UI, Roboto';
      ctx.fillStyle = 'rgba(230,237,243,0.75)';
      ctx.fillText('Arrow keys / WASD • Space pause • R restart', canvas.width/2, canvas.height/2 + 18);
    }

    if (state.over) {
      ctx.fillStyle = 'rgba(0,0,0,0.45)';
      ctx.fillRect(0,0,canvas.width,canvas.height);
      ctx.fillStyle = 'rgba(230,237,243,0.95)';
      ctx.font = '700 30px system-ui, -apple-system, Segoe UI, Roboto';
      ctx.textAlign = 'center';
      ctx.fillText('Game Over', canvas.width/2, canvas.height/2 - 12);
      ctx.font = '14px system-ui, -apple-system, Segoe UI, Roboto';
      ctx.fillStyle = 'rgba(230,237,243,0.8)';
      ctx.fillText('Press R or click Restart', canvas.width/2, canvas.height/2 + 16);
    }
  }

  function loop(t) {
    raf = requestAnimationFrame(loop);
    const dt = t - last;
    last = t;
    acc += dt;
    while (acc >= state.tickMs) {
      step();
      acc -= state.tickMs;
      if (state.over) break;
    }
    draw();
  }

  // input
  window.addEventListener('keydown', (e) => {
    if (e.code === 'Space') { e.preventDefault(); togglePause(); return; }
    if (e.code === 'KeyR') { e.preventDefault(); reset(); start(); return; }
    const d = keyDirs[e.code];
    if (d) { e.preventDefault(); setDir(d); }
  }, {passive:false});

  btn.addEventListener('click', () => {
    if (state.over) { reset(); start(); return; }
    if (paused) start(); else togglePause();
  });

  // simple swipe controls
  let touchStart = null;
  canvas.addEventListener('touchstart', (e) => {
    const t = e.touches[0];
    touchStart = {x:t.clientX, y:t.clientY};
  }, {passive:true});
  canvas.addEventListener('touchend', (e) => {
    if (!touchStart) return;
    const t = e.changedTouches[0];
    const dx = t.clientX - touchStart.x;
    const dy = t.clientY - touchStart.y;
    touchStart = null;
    if (Math.abs(dx) < 12 && Math.abs(dy) < 12) return;
    if (Math.abs(dx) > Math.abs(dy)) {
      setDir(dx > 0 ? [1,0] : [-1,0]);
    } else {
      setDir(dy > 0 ? [0,1] : [0,-1]);
    }
    if (paused && !state.over) start();
  }, {passive:true});

  // on-screen buttons (mobile)
  const dirMap = { up:[0,-1], down:[0,1], left:[-1,0], right:[1,0] };
  const padButtons = document.querySelectorAll('.dpad .pad');
  padButtons.forEach(b => {
    const dir = b.getAttribute('data-dir');
    const action = b.getAttribute('data-action');
    const handler = (e) => {
      e.preventDefault();
      if (action === 'pause') { togglePause(); return; }
      if (action === 'restart') { reset(); start(); return; }
      if (dir && dirMap[dir]) {
        setDir(dirMap[dir]);
        if (paused && !state.over) start();
      }
    };
    b.addEventListener('pointerdown', handler, {passive:false});
    b.addEventListener('click', handler, {passive:false});
  });

  // init
  reset();
  draw();
})();
</script>

<!-- Firebase (CDN) -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyCabc1Y1PcWRBJa4M68iNsDKYKKJYsfqss",
    authDomain: "snake-ad6ee.firebaseapp.com",
    projectId: "snake-ad6ee",
    storageBucket: "snake-ad6ee.firebasestorage.app",
    messagingSenderId: "980134111718",
    appId: "1:980134111718:web:c1c74fa8f13570375b4e27"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  auth.signInAnonymously().catch((e) => {
    console.warn('Anonymous auth failed:', e);
  });

  const lbList = document.getElementById('lbList');
  const lbHint = document.getElementById('lbHint');

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }

  async function loadLeaderboard(){
    if (!lbList) return;
    lbList.innerHTML = '<li class="lb-muted">載入中…</li>';
    try{
      const snap = await db.collection('scores')
        .orderBy('score','desc')
        .orderBy('createdAt','asc')
        .limit(10)
        .get();

      if (snap.empty){
        lbList.innerHTML = '<li class="lb-muted">暫時未有人上榜</li>';
        return;
      }

      const items = [];
      snap.forEach(doc => {
        const d = doc.data() || {};
        items.push({name: d.name || '玩家', score: d.score ?? 0});
      });

      lbList.innerHTML = items.map((it, idx) =>
        `<li>#${idx+1} ${escapeHtml(it.name)} — <b>${it.score}</b></li>`
      ).join('');

    } catch (e){
      console.warn(e);
      lbList.innerHTML = '<li class="lb-muted">載入失敗（可能未設定 Firebase config）</li>';
    }
  }

  window.__snakebite_lb = {
    loadLeaderboard,
    async submitScore(score){
      try{
        await auth.onAuthStateChanged(async (u) => {
          if (!u) return;
          const key = 'snakebite_name';
          let name = localStorage.getItem(key) || '';
          if (!name){
            name = prompt('輸入上榜名稱（1-20字）', 'Ryan') || '';
            name = name.trim().slice(0,20);
            if (!name) name = '玩家';
            localStorage.setItem(key, name);
          }
          await db.collection('scores').add({
            name,
            score: Math.max(0, Math.floor(score)),
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            ua: navigator.userAgent.slice(0,120),
          });
          lbHint && (lbHint.textContent = '已提交分數 ✅');
          setTimeout(() => { if (lbHint) lbHint.textContent = '完成一局後會自動提交分數（匿名）'; }, 1500);
          await loadLeaderboard();
        });
      } catch (e){
        console.warn('submitScore failed', e);
        lbHint && (lbHint.textContent = '提交失敗（請檢查 Firebase 設定）');
      }
    }
  };

  loadLeaderboard();
</script>
</body>
</html>
